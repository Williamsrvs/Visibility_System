<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/produto.css') }}">
    <meta name="robots" content="noindex,nofollow">
</head>
<body>

    <!-- Bot√£o Mobile Menu -->
    <button class="menu_toggle" onclick="toggleMenu()">‚ò∞</button>

    <!-- Sidebar lateral -->
    <nav class="sidebar_menu" id="sidebar">
        
        <div class="sidebar_header">
            <h2>Menu Navega√ß√£o</h2>
                </div>
            <img src="https://raw.githubusercontent.com/Williamsrvs/img_catalogodigital/refs/heads/main/logo%20pedido%20certo.png" alt="Logo Date Analytics" class="sidebar_logo" style="height: auto; margin-bottom: 10px;">    
            
        
        <div class="menu_list">
            <button id="toggleFormBtn" class="btn" >‚ûï Adicionar produto</button>
            <button id="homeBtn" onclick="window.location.href='/produto_excel'" class="btn">‚è¨ Lista Produtos</button>
            <button id="logoutBtn" onclick="window.location.href='/lojista'" class="btn">‚ùå Sair</button>
        </div>
        <footer class="sidebar_footer">
            <p>&copy; 2025 Todos os direitos reservados, Date Analytics</p>
        </footer>
    </nav>
<div class="container">
    <div class="header">
        
    </div>

    <div class="layout">
    <!-- Formul√°rio lateral -->
    <aside class="form-card" id="productForm" aria-labelledby="form-title">
        <h2 id="form-title">Adicionar produto</h2>
        <form action="/produto" method="POST" enctype="multipart/form-data">
        <div class="form-row">
            <div class="col">
            <label for="nome_prod">Nome</label>
            <input id="nome_prod" type="text" name="nome_prod" placeholder="Nome do produto" required>
            </div>
        </div>

        <div style="margin-top:10px">
            <label for="descricao">Descri√ß√£o</label>
            <textarea id="descricao" name="descricao" placeholder="Descri√ß√£o" required></textarea>
        </div>

        <div style="margin-top:10px">
    <label for="subgrupo">Subgrupo</label>
    <select id="subgrupo" name="subgrupo" required class="form-control">
    <option value="">Selecione um subgrupo</option>
    <option value="Prato da Casa">Prato da Casa</option>
    <option value="Acompanhamento">Acompanhamento</option>
    <option value="Sobremesa">Sobremesa</option>
    <option value="Por√ß√£o">Por√ß√£o</option>
    <option value="Peixada">Peixada</option>
    <option value="Bebidas">Bebidas</option>
    <option value="Quentinha">Quentinha (M)</option>
    <option value="Quentinha">Quentinha (G)</option>

    </select>
    </div>

    <div style="margin-top:10px">
    <label for="status_promocao">Status Promo√ß√£o</label>
    <select id="status_promocao" name="status_promocao" required class="form-control">
    <option value="">Selecione um Status</option>
    <option value="Promo√ß√£o da casa">Promo√ß√£o da casa</option>
    <option value="Black Friday">Black Friday</option>
    <option value="Sem promo√ß√£o">Sem promo√ß√£o</option>
    </select>
    </div>


        <div class="form-row" style="margin-top:10px">
            <div class="col">
            <label for="valor">Valor (R$)</label>
            <input id="valor" type="number" step="0.01" name="valor" placeholder="0.00" required>
            </div>
            <div class="col">
            <label for="form_pgmto">Forma de pagamento</label>
            <input id="form_pgmto" type="text" name="form_pgmto" placeholder="Cart√£o / Pix / Dinheiro" required>
            </div>
        </div>

        <div style="margin-top:10px">
            <label for="imagem_url">Imagem</label>
            <input id="imagem_url" type="file" name="imagem_url" accept="image/*">
        </div>

        <button class="btn-submit" type="submit">Salvar produto</button>
        </form>
    </aside>

    <!-- Lista de produtos -->
    <section class="products" aria-live="polite">
        {% if produtos is defined and produtos %}
        {% for p in produtos %}
            <article class="product-card">
            {% if p.imagem_url %}
                <img src="data:image/jpeg;base64,{{ p.imagem_url|b64encode }}" alt="{{ p.nome_prod }}">
            {% else %}
                <div class="placeholder">Sem imagem</div>
            {% endif %}
            <div class="product-info">
                <h3>{{ p.nome_prod }}</h3>
                <p class="desc">{{ p.descricao }}</p>
                <p class="subgrupo"><strong>Grupo:</strong> {{ p.subgrupo }}</p>
                <p class="promocao"><strong>Promo√ß√£o do Dia:</strong> <span>{{ p.status_promocao }}</span></p>
                <div class="meta">
                <span class="price">R$ {{ "%.2f"|format(p.valor|float) }}</span>
                <span class="pay">{{ p.form_pgmto }}</span>
                </div>
                <div class="actions">
                <button onclick="editarProduto({{ p.id_prod }})" class="btn-action edit">Editar</button>
                
                </div>
                <div class="visibility-control" style="margin-top: 10px; padding: 8px; background: #f5f5f5; border-radius: 4px;">
                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px;">
                        <input type="checkbox" id="visible{{ p.id_prod }}" 
                            {% if p.ativo == 1 %}checked{% endif %}
                            onchange="toggleVisibilidade({{ p.id_prod }}, this.checked)"
                            style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                        <span>{% if p.ativo == 1 %}‚úÖ Vis√≠vel no √≠ndice{% else %}üö´ Oculto do √≠ndice{% endif %}</span>
                    </label>
                </div>
            </div>

            <!-- Modal de edi√ß√£o -->
            <div id="editModal{{ p.id_prod }}" class="modal">
                <div class="modal-content">
                <h3>Editar Produto</h3>
                <form id="editForm{{ p.id_prod }}" onsubmit="atualizarProduto(event, {{ p.id_prod }}); return false;">
                    <div class="form-row">
                    <div class="col">
                        <label for="edit_nome{{ p.id_prod }}">Nome:</label>
                        <input type="text" id="edit_nome{{ p.id_prod }}" name="nome_prod" value="{{ p.nome_prod }}" required>
                    </div>
                    </div>
                    <div class="form-row">
                    <div class="col">
                        <label for="edit_desc{{ p.id_prod }}">Descri√ß√£o:</label>
                        <textarea id="edit_desc{{ p.id_prod }}" name="descricao" required>{{ p.descricao }}</textarea>
                    </div>
                    </div>

                    <div class="form-row">
        <div class="col">
            <label for="edit_subgrupo{{ p.id_prod }}">Subgrupo:</label>
            <select id="edit_subgrupo{{ p.id_prod }}" name="subgrupo" required class="form-control">
            <option value="">Selecione um subgrupo</option>
            <option value="Prato da Casa" {% if p.subgrupo == 'Prato da Casa' %}selected{% endif %}>Prato da Casa</option>
            <option value="Acompanhamento" {% if p.subgrupo == 'Acompanhamento' %}selected{% endif %}>Acompanhamento</option>
            <option value="Sobremesa" {% if p.subgrupo == 'Sobremesa' %}selected{% endif %}>Sobremesa</option>
            <option value="Peixada" {% if p.subgrupo == 'Peixada' %}selected{% endif %}>Peixada</option>
            <option value="Quentinha (M)" {% if p.subgrupo == 'Quentinha (M)' %}selected{% endif %}>Quentinha (M)</option>
            <option value="Quentinha (G)" {% if p.subgrupo == 'Quentinha (G)' %}selected{% endif %}>Quentinha (G)</option>
            <option value="Por√ß√£o" {% if p.subgrupo == 'Por√ß√£o' %}selected{% endif %}>Por√ß√£o</option>
        
        
        </select>
        </div>
        </div>
        
                    <div class="form-row">
        <div class="col">
            <label for="edit_status_promocao{{ p.id_prod }}">Status Promo√ß√£o:</label>
            <select id="edit_status_promocao{{ p.id_prod }}" name="status_promocao" required class="form-control">
            <option value="">Selecione um Status</option>
            <option value="Promo√ß√£o da casa" {% if p.status_promocao == 'Promo√ß√£o da casa' %}selected{% endif %}>Promo√ß√£o da casa</option>
            <option value="Black Friday" {% if p.status_promocao == 'Black Friday' %}selected{% endif %}>Black Friday</option>
            <option value="Sem promo√ß√£o" {% if p.status_promocao == 'Sem promo√ß√£o' %}selected{% endif %}>Sem promo√ß√£o</option>
        </select>
        </div>
                    </div>

                    <div class="form-row">
        <div class="col">
        <label for="edit_valor{{ p.id_prod }}">Valor:</label>
        <input type="number" step="0.01" id="edit_valor{{ p.id_prod }}" name="valor" value="{{ p.valor }}" required>
                    </div>
                    <div class="col">
                        <label for="edit_pgto{{ p.id_prod }}">Forma de Pagamento:</label>
                        <input type="text" id="edit_pgto{{ p.id_prod }}" name="form_pgmto" value="{{ p.form_pgmto }}" required>
                    </div>
                    </div>
                    <div class="form-row">
                    <div class="col">
                        <label for="edit_img{{ p.id_prod }}">Nova Imagem:</label>
                        <input type="file" id="edit_img{{ p.id_prod }}" name="imagem_url" accept="image/*">
                    </div>
                    </div>
                    <div class="modal-buttons">
                    <button type="submit" class="btn-submit">Salvar</button>
                    <button type="button" onclick="fecharModal({{ p.id_prod }})" class="btn-cancel">Cancelar</button>
                    </div>
                </form>
                </div>
            </div>
            </article>
        {% endfor %}
        {% else %}
        <p class="empty">Nenhum produto cadastrado.</p>
        {% endif %}
    </section>

    </div>
</div>

<script>
    // Toggle simples para mostrar/ocultar o formul√°rio em telas pequenas
    
    function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        // Fecha o menu ao clicar fora (mobile)
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.querySelector('.menu_toggle');
            
            if (window.innerWidth <= 768) {
                if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                    sidebar.classList.remove('active');
                }
            }
        });
    
    
    
    (function(){
    const btn = document.getElementById('toggleFormBtn');
    const form = document.getElementById('productForm');
    if(!btn || !form) return;
    btn.addEventListener('click', ()=>{
        const isHidden = form.style.display === 'none' || getComputedStyle(form).display === 'none';
        form.style.display = isHidden ? 'block' : 'none';
        btn.textContent = isHidden ? 'Fechar' : 'Adicionar produto';
    });
    // Em telas pequenas, come√ßar com formul√°rio oculto
    if(window.innerWidth <= 960){ form.style.display = 'none'; }
    })();

    // Fun√ß√µes para edi√ß√£o e exclus√£o de produtos
    function editarProduto(id) {
    const modal = document.getElementById(`editModal${id}`);
    if (modal) {
        modal.style.display = 'flex';
    }
    }

    function fecharModal(id) {
    const modal = document.getElementById(`editModal${id}`);
    if (modal) {
        modal.style.display = 'none';
    }
    }

    function atualizarProduto(event, id) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    fetch(`/produto/${id}`, {
        method: 'PUT',
        body: formData
    })
    .then(response => {
        if (response.ok) {
        alert('Produto atualizado com sucesso!');
        window.location.reload();
        } else {
        return response.text().then(text => {
            console.error('Erro do servidor:', text);
            alert('Erro ao atualizar produto');
        });
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao atualizar produto: ' + error.message);
    });
    }

    function deletarProduto(id) {
    fetch(`/produto/${id}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (response.ok) {
        alert('Produto exclu√≠do com sucesso!');
        window.location.reload();
        } else {
        alert('Erro ao excluir produto');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao excluir produto');
    });
    }

    function toggleVisibilidade(id, visivel) {
    const status = visivel ? 1 : 0;
    const mensagem = visivel ? 'Produto agora est√° vis√≠vel' : 'Produto oculto do √≠ndice';
    
    fetch(`/produto/${id}/visibilidade`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ ativo: status })
    })
    .then(response => {
        if (response.ok) {
            console.log(mensagem);
            // Atualizar o label
            const checkbox = document.getElementById(`visible${id}`);
            const label = checkbox.nextElementSibling;
            if (visivel) {
                label.textContent = '‚úÖ Vis√≠vel no √≠ndice';
            } else {
                label.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è Oculto do √≠ndice';
            }
        } else {
            alert('Erro ao atualizar visibilidade do produto');
            checkbox.checked = !checkbox.checked;
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao atualizar visibilidade: ' + error.message);
        document.getElementById(`visible${id}`).checked = !document.getElementById(`visible${id}`).checked;
    });
    }
</script>



</body>
</html>